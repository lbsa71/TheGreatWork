<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialogue Tree Player</title>
    <style>
        /* Reset and basic styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .player-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .player-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .player-header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .current-node {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .player-content {
            padding: 30px;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error state */
        .error {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* History */
        .history-section {
            margin-bottom: 24px;
        }

        .history-toggle {
            background: none;
            border: none;
            color: #4f46e5;
            cursor: pointer;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .history-toggle:hover {
            background-color: #f3f4f6;
        }

        .history-content {
            margin-top: 12px;
            padding: 16px;
            background-color: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #4f46e5;
            display: none;
        }

        .history-content.show {
            display: block;
        }

        .history-step {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-step:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .history-situation {
            font-style: italic;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .history-choice {
            color: #4f46e5;
            font-weight: 600;
        }

        /* Situation */
        .situation-section {
            margin-bottom: 32px;
        }

        .situation-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #374151;
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }

        /* Choices */
        .choices-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice-button {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px 20px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            color: #374151;
        }

        .choice-button:hover {
            border-color: #4f46e5;
            background-color: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }

        .choice-text {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .choice-next {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .choice-effects {
            font-size: 0.8rem;
            color: #059669;
            background-color: #ecfdf5;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .choice-unavailable {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }

        .choice-unavailable:hover {
            transform: none;
            box-shadow: none;
            border-color: #e5e7eb;
            background-color: #f3f4f6;
        }

        /* Game parameters */
        .params-section {
            background-color: #f1f5f9;
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .param-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .param-name {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 2px;
        }

        .param-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0f172a;
        }

        /* End state */
        .end-state {
            text-align: center;
            padding: 40px 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 2px dashed #d1d5db;
        }

        .end-state h3 {
            color: #374151;
            margin-bottom: 12px;
        }

        .restart-button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 16px;
        }

        .restart-button:hover {
            transform: translateY(-1px);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .player-content {
                padding: 20px;
            }

            .choice-button {
                padding: 14px 16px;
            }

            .params-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="player-container">
        <div class="player-header">
            <h1>Dialogue Tree Player</h1>
            <div class="current-node" id="currentNodeDisplay">Loading...</div>
        </div>
        <div class="player-content" id="playerContent">
            <div class="loading">
                <div class="spinner"></div>
                <div>Loading dialogue tree...</div>
            </div>
        </div>
    </div>

    <script>
        class DialogueTreePlayer {
            constructor() {
                this.treeData = null;
                this.currentNodeId = 'start';
                this.history = [];
                this.gameParams = {};
                
                this.init();
            }

            async init() {
                try {
                    await this.loadTree();
                    this.startGame();
                } catch (error) {
                    this.showError('Failed to load dialogue tree: ' + error.message);
                }
            }

            async loadTree() {
                // Get JSON file from URL parameter or default to 'tree.json'
                const urlParams = new URLSearchParams(window.location.search);
                const jsonFile = urlParams.get('json') || 'tree.json';
                
                const response = await fetch(jsonFile);
                if (!response.ok) {
                    throw new Error(`Failed to load ${jsonFile}: ${response.status} ${response.statusText}`);
                }
                
                this.treeData = await response.json();
                this.gameParams = this.treeData.params || {};
            }

            startGame() {
                this.currentNodeId = 'start';
                this.history = [];
                // Reset game parameters to original values
                this.gameParams = JSON.parse(JSON.stringify(this.treeData.params || {}));
                this.renderCurrentNode();
            }

            showError(message) {
                const content = document.getElementById('playerContent');
                content.innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${message}
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="restart-button" onclick="location.reload()">Retry</button>
                    </div>
                `;
            }

            renderCurrentNode() {
                const node = this.treeData.nodes[this.currentNodeId];
                
                // Update current node display
                document.getElementById('currentNodeDisplay').textContent = 
                    `Current Node: ${this.currentNodeId}`;

                if (!node) {
                    this.showError(`Node "${this.currentNodeId}" not found in dialogue tree.`);
                    return;
                }

                if (node === null) {
                    this.showError(`Node "${this.currentNodeId}" is incomplete (null).`);
                    return;
                }

                const content = document.getElementById('playerContent');
                
                let html = '';

                // History section
                if (this.history.length > 0) {
                    html += this.renderHistory();
                }

                // Current situation
                html += `
                    <div class="situation-section">
                        <h2 class="section-title">üìñ Current Situation</h2>
                        <div class="situation-text">${node.situation || 'No situation text available.'}</div>
                    </div>
                `;

                // Choices
                if (node.choices && node.choices.length > 0) {
                    html += this.renderChoices(node.choices);
                } else {
                    // End of tree
                    html += `
                        <div class="end-state">
                            <h3>End of Story</h3>
                            <p>You've reached the end of this dialogue path.</p>
                            <button class="restart-button" onclick="player.startGame()">Start Over</button>
                        </div>
                    `;
                }

                // Game parameters
                if (Object.keys(this.gameParams).length > 0) {
                    html += this.renderGameParams();
                }

                content.innerHTML = html;
            }

            renderHistory() {
                let historyHtml = `
                    <div class="history-section">
                        <button class="history-toggle" onclick="this.nextElementSibling.classList.toggle('show')">
                            üìú Story History (${this.history.length} step${this.history.length !== 1 ? 's' : ''})
                        </button>
                        <div class="history-content">
                `;

                this.history.forEach((step, index) => {
                    historyHtml += `
                        <div class="history-step">
                            <div class="history-situation">${step.situation}</div>
                            <div class="history-choice">‚Üí ${step.choice}</div>
                        </div>
                    `;
                });

                historyHtml += `
                        </div>
                    </div>
                `;

                return historyHtml;
            }

            renderChoices(choices) {
                let choicesHtml = `
                    <div class="choices-section">
                        <h2 class="section-title">üéØ Your Choices</h2>
                        <div class="choices-container">
                `;

                choices.forEach((choice, index) => {
                    const isAvailable = choice.next && this.treeData.nodes[choice.next] !== undefined;
                    const buttonClass = isAvailable ? 'choice-button' : 'choice-button choice-unavailable';
                    
                    choicesHtml += `
                        <button class="${buttonClass}" ${isAvailable ? `onclick="player.makeChoice(${index})"` : 'disabled'}>
                            <div class="choice-text">${choice.text}</div>
                            <div class="choice-next">‚Üí ${choice.next || 'Unknown destination'}</div>
                    `;

                    if (choice.effects && Object.keys(choice.effects).length > 0) {
                        const effectsText = Object.entries(choice.effects)
                            .map(([key, value]) => `${key}: ${value > 0 ? '+' : ''}${value}`)
                            .join(', ');
                        choicesHtml += `<div class="choice-effects">Effects: ${effectsText}</div>`;
                    }

                    choicesHtml += '</button>';
                });

                choicesHtml += `
                        </div>
                    </div>
                `;

                return choicesHtml;
            }

            renderGameParams() {
                let paramsHtml = `
                    <div class="params-section">
                        <h3 class="section-title">‚öôÔ∏è Game Parameters</h3>
                        <div class="params-grid">
                `;

                Object.entries(this.gameParams).forEach(([key, value]) => {
                    paramsHtml += `
                        <div class="param-item">
                            <div class="param-name">${key}</div>
                            <div class="param-value">${value}</div>
                        </div>
                    `;
                });

                paramsHtml += `
                        </div>
                    </div>
                `;

                return paramsHtml;
            }

            makeChoice(choiceIndex) {
                const currentNode = this.treeData.nodes[this.currentNodeId];
                const choice = currentNode.choices[choiceIndex];

                if (!choice || !choice.next) {
                    this.showError('Invalid choice selected.');
                    return;
                }

                // Add to history
                this.history.push({
                    nodeId: this.currentNodeId,
                    situation: currentNode.situation,
                    choice: choice.text
                });

                // Apply choice effects to game parameters
                if (choice.effects) {
                    Object.entries(choice.effects).forEach(([param, change]) => {
                        if (typeof change === 'number') {
                            this.gameParams[param] = (this.gameParams[param] || 0) + change;
                        }
                    });
                }

                // Navigate to next node
                this.currentNodeId = choice.next;
                this.renderCurrentNode();

                // Scroll to top for better UX
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Initialize the player when the page loads
        let player;
        document.addEventListener('DOMContentLoaded', () => {
            player = new DialogueTreePlayer();
        });
    </script>
</body>
</html>